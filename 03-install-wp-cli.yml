---
- hosts: wordpress-hosts
  vars:
  remote_user: deploy

  tasks:

  - name: See if it's already at its destination.
    stat: path=/usr/local/bin/wp
    register: wp

  - name: Create downloads directory if not present
    file: dest=/home/deploy/downloads  state=directory
    when: not wp.stat.exists

  - name: Download WordPress Command Line utility
    get_url:
      url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
      dest: /home/deploy/downloads
    when: not wp.stat.exists

  - name: Set WP-CLI executable bit
    file: path=/home/deploy/downloads/wp-cli.phar  mode="u=rwx,g=rx,o=rx"
    when: not wp.stat.exists

  - name: Copy to destination if not already there.
    become: true
    command: cp  /home/deploy/downloads/wp-cli.phar  /usr/local/bin/wp
    when: not wp.stat.exists
